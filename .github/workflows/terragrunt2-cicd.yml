name: 'Terragrunt CI'
on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Choose the environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  AWS_REGION: us-east-1
#  ENVIRONMENT: staging
  AWS_OIDC_ROLE_ARN: arn:aws:iam::214633882441:role/GitHubActionsRole

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set environment variable
        run: echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ env.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform v1.7.4
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 1.7.4
          terraform_wrapper: true

      - name: Setup Terraform version
        run: terraform --version
  
      - name: Setup Terraform wrapper path
        run: which terraform
  
      - name: Setup Terragrunt v0.50.16
        run: |
          sudo wget -q -O /bin/terragrunt "https://github.com/gruntwork-io/terragrunt/releases/download/v0.50.16/terragrunt_linux_amd64"
          sudo chmod +x /bin/terragrunt
          terragrunt -v


      - name: Initialize Terragrunt in VPC directory
        run: |
          cd environments/${{ env.ENVIRONMENT }}/us-east-1/vpc
          terragrunt init --terragrunt-non-interactive
  
      - name: Plan Terragrunt in all subdirectories
        run: |
          cd environments/${{ env.ENVIRONMENT }}/us-east-1
          terragrunt run-all plan --terragrunt-non-interactive | tee plan.out
  
      - name: Apply Terragrunt if on main branch
#        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          cd environments/${{ env.ENVIRONMENT }}/us-east-1
          terragrunt run-all apply --terragrunt-non-interactive
  